#!/bin/bash
# =====================================================
# Stage9MotorBridge FÂ´ v3.1.0 Build & GDS Launcher
# =====================================================

set -euo pipefail
IFS=$'\n\t'

echo "ðŸš€ Starting Stage9MotorBridge Deployment Setup"

# -------------------------
# Paths
# -------------------------
BASE_DIR=~/fprime-motorbridge
PROJECT_DIR="$BASE_DIR/Projects/Stage9Project"
DEPLOY_DIR="$PROJECT_DIR/Deployments/Stage9MotorBridgeDeployment"
DEPLOY_FPP="$DEPLOY_DIR/Stage9MotorBridgeDeployment.fpp"
TOPO_DIR="$PROJECT_DIR/Topologies"
TOPO_FILE="$TOPO_DIR/Stage9MotorBridgeTopology.fpp"
TOOLCHAIN_DIR="$BASE_DIR/fprime-3.1.0/cmake/toolchain"

# -------------------------
# Activate virtualenv
# -------------------------
source "$BASE_DIR/fprime-venv-310/bin/activate"
echo "âœ… Virtualenv activated"

# -------------------------
# Clean old builds
# -------------------------
echo "ðŸ§¹ Cleaning old builds and cache..."
cd "$PROJECT_DIR"
rm -rf build* .fprime-cache

# -------------------------
# Ensure deployment FPP exists
# -------------------------
mkdir -p "$DEPLOY_DIR"
cat > "$DEPLOY_FPP" << EOF
deployment Stage9MotorBridgeDeployment {
    platform = "linux"
    topology = Stage9MotorBridgeTopology
}
EOF
echo "âœ… Deployment FPP created/fixed"

# -------------------------
# Ensure topology FPP exists
# -------------------------
mkdir -p "$TOPO_DIR"
if [ ! -f "$TOPO_FILE" ]; then
    cat > "$TOPO_FILE" << EOF
Topology Stage9MotorBridgeTopology {
    # Components go here
}
EOF
    echo "âœ… Topology FPP created"
else
    echo "âœ… Topology FPP exists"
fi

# -------------------------
# Ensure Linux toolchain exists
# -------------------------
cd "$TOOLCHAIN_DIR"
if [ ! -f linux.cmake ]; then
    cp generic.cmake linux.cmake
    echo "âœ… Linux toolchain created from generic.cmake"
else
    echo "âœ… Linux toolchain exists"
fi

# -------------------------
# Generate deployment
# -------------------------
cd "$PROJECT_DIR"
echo "âš™ï¸ Generating Stage9MotorBridgeDeployment..."
if fprime-util generate Stage9MotorBridgeDeployment --platform linux; then
    echo "âœ… Deployment generated successfully"
else
    echo "âŒ Deployment generation FAILED! Check FPP/toolchain"
    exit 1
fi

# -------------------------
# Build deployment
# -------------------------
echo "âš™ï¸ Building Stage9MotorBridgeDeployment..."
if fprime-util build Stage9MotorBridgeDeployment; then
    echo "âœ… Deployment built successfully"
else
    echo "âŒ Deployment build FAILED!"
    exit 1
fi

# -------------------------
# Verify build output
# -------------------------
BUILD_DIR="$PROJECT_DIR/build-fprime-automatic-Stage9MotorBridgeDeployment"
if [ -d "$BUILD_DIR" ]; then
    echo "âœ… Build directory exists: $BUILD_DIR"
else
    echo "âŒ Build directory missing! Something went wrong."
    exit 1
fi

# -------------------------
# Launch GDS
# -------------------------
echo "ðŸš€ Launching GDS..."
fprime-gds --app "$DEPLOY_DIR/Stage9MotorBridgeDeployment.fpp"
